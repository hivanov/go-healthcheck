package mariadb

import (
	"github.com/hivanov/go-healthcheck/src/core"
	"testing"
	"time"

	"github.com/stretchr/testify/assert"
)

func FuzzMariaDBChecker_New(f *testing.F) {
	f.Add("testuser:testpass@tcp(localhost:3306)/testdb")
	f.Fuzz(func(t *testing.T, connectionString string) {
		descriptor := core.Descriptor{
			ComponentID:   "fuzz-test",
			ComponentType: "mariadb",
		}
		checkInterval := 10 * time.Millisecond
		queryTimeout := 50 * time.Millisecond

		checker, err := New(descriptor, checkInterval, queryTimeout, connectionString)
		// New may or may not return an error depending on the driver's ability to parse the conn string.
		// We handle both cases.
		if err != nil {
			return // Valid scenario, connection string was invalid from the start.
		}

		if checker == nil {
			t.Fatalf("New returned nil checker without an error for connection string: %s", connectionString)
		}

		defer func() {
			assert.NoError(t, checker.Close(), "Checker Close() returned an unexpected error")
		}()

		// Allow some time for the initial check to happen.
		time.Sleep(checkInterval * 2)

		status := checker.Status()
		// Status will likely be Fail because the connection string is random.
		// We are mainly interested in ensuring no panics occur.
		assert.NotEqual(t, core.StatusPass, status.Status, "Expected status not to be 'pass' with a random connection string")

		// Exercise other getters
		_ = checker.Descriptor()
		_ = checker.StatusChange()
	})
}
